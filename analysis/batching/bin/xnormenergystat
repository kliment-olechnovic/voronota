#!/bin/bash

readonly BINDIR=$1
readonly OUTPUTDIR=$2
readonly NVMODE=$3

WORKDIR=$OUTPUTDIR/normenergystat/$NVMODE
mkdir -p $WORKDIR

find $OUTPUTDIR/normenergy/ -type f | while read INPUTFILE
do
	INPUTBASENAME=$(basename $INPUTFILE)
	INPUTSIZE=$(cat $OUTPUTDIR/vballs/$INPUTBASENAME | egrep 'A<CA>' | wc -l)
	if [ "$INPUTSIZE" -gt 100 ]
	then
		if [ "$NVMODE" == "00" ]
		then
			cat $INPUTFILE | awk '{print $1 " " $3}' >> $WORKDIR/table
		fi

		if [ "$NVMODE" == "10" ]
		then
			cat $INPUTFILE | awk '{print $1 "_" $2 " " $3}' >> $WORKDIR/table
		fi

		if [ "$NVMODE" == "01" ]
		then
			cat $INPUTFILE | awk '{print $1 " " $4}' >> $WORKDIR/table
		fi

		if [ "$NVMODE" == "11" ]
		then
			cat $INPUTFILE | awk '{print $1 "_" $2 " " $4}' >> $WORKDIR/table
		fi

		echo $INPUTBASENAME >> $WORKDIR/input_accepted
	else
		echo $INPUTBASENAME >> $WORKDIR/input_rejected
	fi
done

cd $WORKDIR

R --vanilla << 'EOF' > /dev/null

t=read.table("table", header=FALSE, stringsAsFactors=FALSE);
names=sort(union(t$V1, t$V1));

histbreaks=seq(min(t$V2)-0.05, max(t$V2)+0.05, 0.01);
hist(t$V2, breaks=histbreaks, col=rgb(1, 0, 0, 0.5), freq=FALSE, main="All atoms");

means=c();
sds=c();
for(name in names)
{
	st=t[which(t$V1==name),];
	means=c(means, mean(st$V2));
	sds=c(sds, sd(st$V2));
	hist(st$V2, breaks=histbreaks, col=rgb(0, 0, 1, 0.5), freq=FALSE, main=name);
}

mt=data.frame(names=names, means=means, sds=sds);
mt=mt[order(mt$means),];
write.table(mt, "means_and_sds", col.names=FALSE, row.names=FALSE, quote=FALSE);

EOF


if [ "$NVMODE" == "00" ]
then
	cat ./means_and_sds | grep -f $BINDIR/standard_atom_names | sort > ../means_and_sds_noss_simple
fi

if [ "$NVMODE" == "10" ]
then
	cat ./means_and_sds | grep -f $BINDIR/standard_atom_names | grep '_\.' | sed 's/_.//' | sort > ../means_and_sds_loop_simple
	cat ./means_and_sds | grep -f $BINDIR/standard_atom_names | grep '_B' | sed 's/_B//' | sort > ../means_and_sds_sheet_simple
	cat ./means_and_sds | grep -f $BINDIR/standard_atom_names | grep '_H' | sed 's/_H//' | sort > ../means_and_sds_helix_simple
fi

if [ "$NVMODE" == "01" ]
then
	cat ./means_and_sds | grep -f $BINDIR/standard_atom_names | sort > ../means_and_sds_noss_enhanced
fi

if [ "$NVMODE" == "11" ]
then
	cat ./means_and_sds | grep -f $BINDIR/standard_atom_names | grep '_\.' | sed 's/_.//' | sort > ../means_and_sds_loop_enhanced
	cat ./means_and_sds | grep -f $BINDIR/standard_atom_names | grep '_B' | sed 's/_B//' | sort > ../means_and_sds_sheet_enhanced
	cat ./means_and_sds | grep -f $BINDIR/standard_atom_names | grep '_H' | sed 's/_H//' | sort > ../means_and_sds_helix_enhanced
fi
