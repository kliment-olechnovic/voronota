#!/bin/bash

readonly BINDIR=$1
readonly OUTPUTDIR=$2
readonly RMODE=$3

if [ "$RMODE" == "slave" ]
then
	mkdir -p $OUTPUTDIR/potential/slaves
	SLAVEDIR=$(mktemp --tmpdir=$OUTPUTDIR/potential/slaves -d)
	for INPUTFILE in ${@:4}
	do
		INPUTBASENAME=$(basename $INPUTFILE)
		INPUTSIZE=$(cat $OUTPUTDIR/vballs/$INPUTBASENAME | egrep 'A<CA>' | wc -l)
		if [ "$INPUTSIZE" -gt 100 ]
		then
			echo $OUTPUTDIR/vsummary/$INPUTBASENAME $INPUTSIZE >> $SLAVEDIR/input_accepted
		else
			echo $OUTPUTDIR/vsummary/$INPUTBASENAME $INPUTSIZE >> $SLAVEDIR/input_rejected
		fi
	done
	if [ -s "$SLAVEDIR/input_accepted" ]
	then
		cat $SLAVEDIR/input_accepted | awk '{print $1}' | sort | uniq | $BINDIR/voronota score-contacts-potential --input-file-list > $SLAVEDIR/output
	fi
else
	mkdir -p $OUTPUTDIR/potential/master
	
	find $OUTPUTDIR/potential/slaves -type f -name "output" \
	| $BINDIR/voronota score-contacts-potential --input-file-list \
	> $OUTPUTDIR/potential/master/summary_unfiltered
	
	( cat $OUTPUTDIR/potential/master/summary_unfiltered | awk '{print $1}' ; cat $OUTPUTDIR/potential/master/summary_unfiltered | awk '{print $2}' ) \
	| grep -v -f $BINDIR/standard_atom_names \
	| sort \
	| uniq \
	> $OUTPUTDIR/potential/master/nonstandard_atom_names
	
	cat $OUTPUTDIR/potential/master/summary_unfiltered \
	| grep -v -f $OUTPUTDIR/potential/master/nonstandard_atom_names \
	| $BINDIR/voronota score-contacts-potential --potential-file $OUTPUTDIR/potential/master/potential_enhanced \
	> $OUTPUTDIR/potential/master/summary_enhanced
	
	cat $OUTPUTDIR/potential/master/summary_enhanced \
	| awk '{print $1 " " $2 " . " $4}' \
	| $BINDIR/voronota score-contacts-potential --potential-file $OUTPUTDIR/potential/master/potential_simple \
	> $OUTPUTDIR/potential/master/summary_simple
fi
