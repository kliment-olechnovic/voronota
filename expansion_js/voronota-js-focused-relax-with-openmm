#!/bin/bash

function print_help_and_exit
{
cat >&2 << 'EOF'

'voronota-js-focused-relax-with-openmm' script relaxes interfaces in a protein complex.

Options:
    --input | -i              string  *  input file path
    --output | -o             string  *  output file path
    --focus                   string     focus mode, default is 'interface_side_chains', others are: 'whole_interface', 'not_interface', 'whole_structure'
    --conda-path              string     conda installation path, default is ~/anaconda3
    --conda-env               string     conda environment name, default is alphafold2
    --run-faspr               string     path to FASPR binary to rebuild side-chains
    --max-iterations          number     max number of iterations, default is 100
    --pdbfixer                           flag to run PDBFixer before everything
    --help | -h                          flag to display help message and exit

Standard output:
    space-separated table of scores for both input and output
    
Examples:

    voronota-js-focused-relax-with-openmm --input model.pdb --output relaxed_model.pdb

EOF
exit 1
}

readonly ZEROARG=$0

if [ -z "$1" ]
then
	print_help_and_exit
fi

if [[ $ZEROARG == *"/"* ]]
then
	cd $(dirname $ZEROARG)
	export PATH=$(pwd):$PATH
	cd - &> /dev/null
fi

command -v voronota-js &> /dev/null || { echo >&2 "Error: 'voronota-js' executable not in binaries path"; exit 1; }
command -v voronota-js-fast-iface-voromqa &> /dev/null || { echo >&2 "Error: 'voronota-js-fast-iface-voromqa' executable not in binaries path"; exit 1; }

INFILE=""
OUTFILE=""
FOCUS_MODE="interface_side_chains"
CONDA_PATH="${HOME}/anaconda3"
CONDA_ENV="alphafold2"
RUN_FASPR=""
MAX_ITERATIONS="100"
WITH_PDBFIXER="false"
HELP_MODE="false"

while [[ $# > 0 ]]
do
	OPTION="$1"
	OPTARG="$2"
	shift
	case $OPTION in
	-i|--input)
		INFILE="$OPTARG"
		shift
		;;
	-o|--output)
		OUTFILE="$OPTARG"
		shift
		;;
	--focus)
		FOCUS_MODE="$OPTARG"
		shift
		;;
	--conda-path)
		CONDA_PATH="$OPTARG"
		shift
		;;
	--conda-env)
		CONDA_ENV="$OPTARG"
		shift
		;;
	--run-faspr)
		RUN_FASPR="$OPTARG"
		shift
		;;
	--max-iterations)
		MAX_ITERATIONS="$OPTARG"
		shift
		;;
	--pdbfixer)
		WITH_PDBFIXER="true"
		;;
	-h|--help)
		HELP_MODE="true"
		;;
	*)
		echo >&2 "Error: invalid command line option '$OPTION'"
		exit 1
		;;
	esac
done

if [ "$HELP_MODE" == "true" ]
then
	print_help_and_exit
fi

if [ -z "$INFILE" ]
then
	echo >&2 "Error: input file path not provided"
	exit 1
fi

if [ -z "$OUTFILE" ]
then
	echo >&2 "Error: output file path not provided"
	exit 1
fi

if [ ! -s "$INFILE" ]
then
	echo >&2 "Error: input file '$INFILE' does not exist"
	exit 1
fi

if [ "$FOCUS_MODE" != "interface_side_chains" ] && [ "$FOCUS_MODE" != "whole_interface" ] && [ "$FOCUS_MODE" != "not_interface" ] && [ "$FOCUS_MODE" != "whole_structure" ]
then
	echo >&2 "Error: invalid focus mode '$FOCUS_MODE'"
	exit 1
fi

if [ -z "$(which python | grep conda)" ]
then
	if [ ! -s "${CONDA_PATH}/bin/activate" ]
	then
		echo >&2 "Error: no conda activation script '${CONDA_PATH}/bin/activate'"
		exit 1
	fi
	source "${CONDA_PATH}/bin/activate"
fi

if [ "$CONDA_DEFAULT_ENV" != "$CONDA_ENV" ]
then
	conda activate "$CONDA_ENV"
fi

if [ "$CONDA_DEFAULT_ENV" != "$CONDA_ENV" ]
then
	echo >&2 "Error: no '$CONDA_ENV' environment"
	exit 1
fi

readonly TMPLDIR=$(mktemp -d)
trap "rm -r $TMPLDIR" EXIT

cp "$INFILE" "$TMPLDIR/input.pdb"

cd "$TMPLDIR"

if [ -n "$RUN_FASPR" ]
then
	{
cat << 'EOF'
voronota_import("-file", "input.pdb");
voronota_assert_partial_success("Failed to import file");

voronota_run_faspr("-faspr-binary", 'RUN_FASPR');
voronota_assert_full_success("Failed to run FASPR");

voronota_export_atoms("-as-pdb", "-file", "prepared_with_faspr.pdb");
voronota_assert_full_success("Failed to export annotated atoms");
EOF
	} \
	| sed "s|RUN_FASPR|${RUN_FASPR}|" \
	> runfaspr.vs

	echo >&2 "Running FASPR from voronota-js"
	time -p voronota-js --no-setup-defaults < runfaspr.vs
else
	cp "input.pdb" "prepared_with_faspr.pdb"
fi

if [ ! -s "prepared_with_faspr.pdb" ]
then
	echo >&2 "Error: failed to prepare input"
	exit 1
fi

if [ "$WITH_PDBFIXER" == "true" ]
then
	{
cat << 'EOF'
from pdbfixer import PDBFixer
from simtk.openmm.app import PDBFile
fixer = PDBFixer(filename='prepared_with_faspr.pdb')
fixer.findMissingResidues()
fixer.findNonstandardResidues()
fixer.replaceNonstandardResidues()
fixer.removeHeterogens(True)
fixer.findMissingAtoms()
fixer.addMissingAtoms()
PDBFile.writeFile(fixer.topology, fixer.positions, open('prepared_with_pdbfixer.pdb', 'w'), keepIds=True)
EOF
	} \
	> pdbfix.py
	
	echo >&2 "Preparing structure file with PDBFixer"
	time -p python pdbfix.py
else
	mv "prepared_with_faspr.pdb" "prepared_with_pdbfixer.pdb"
fi

if [ ! -s "prepared_with_pdbfixer.pdb" ]
then
	echo >&2 "Error: failed to prepare input"
	exit 1
fi

{
cat << 'EOF'
voronota_import("-file", "prepared_with_pdbfixer.pdb", "-include-hydrogens");
voronota_assert_partial_success("Failed to import file");
voronota_export_atoms("-as-pdb", "-file", "prepared_by_filtering.pdb");
voronota_assert_full_success("Failed to export atoms");
EOF
} \
> reformat1.vs

echo >&2 "Filtering structure with voronota-js"
time -p voronota-js --no-setup-defaults < reformat1.vs

if [ ! -s "prepared_by_filtering.pdb" ]
then
	echo >&2 "Error: failed to prepare input"
	exit 1
fi

{
cat << 'EOF'
from simtk.openmm.app import *
from simtk.openmm import *
from simtk.unit import *
pdb = PDBFile('prepared_by_filtering.pdb')
forcefield = ForceField('amber99sb.xml', 'amber99_obc.xml')
modeller = Modeller(pdb.topology, pdb.positions)
modeller.addHydrogens(forcefield)
PDBFile.writeFile(modeller.topology, modeller.positions, open('prepared_with_simtk.pdb', 'w'), keepIds=True)
EOF
} \
> reformat2.py

echo >&2 "Prepare structure file with simtk modeller"
time -p python reformat2.py

if [ ! -s "prepared_with_simtk.pdb" ]
then
	echo >&2 "Error: failed to prepare input"
	exit 1
fi

{
cat << 'EOF'
voronota_import("-file", "prepared_with_simtk.pdb", "-include-hydrogens", "-include-heteroatoms");
voronota_assert_partial_success("Failed to import file");

voronota_select_atoms_close_to_interchain_interface("-name", "actii");
voronota_assert_full_success("Failed to select interface atoms");

voronota_set_tag_of_atoms("-use", "[]", "-tag", "whole_structure");
voronota_assert_full_success("Failed to tag atoms");

voronota_set_tag_of_atoms("-use", "[actii]", "-tag", "whole_interface");
voronota_assert_full_success("Failed to tag atoms");

voronota_set_tag_of_atoms("-use", "(not [actii])", "-tag", "not_interface");
voronota_assert_full_success("Failed to tag atoms");

voronota_set_tag_of_atoms("-use", "([actii] and (not [-aname C,N,O,CA]))", "-tag", "interface_side_chains");
voronota_assert_full_success("Failed to tag atoms");

voronota_export_atoms("-file", "annotated.pa");
voronota_assert_full_success("Failed to export annotated atoms");
EOF

} \
> annotate.vs

echo >&2 "Annotating structure with voronota-js"
time -p voronota-js --no-setup-defaults < annotate.vs

if [ ! -f "annotated.pa" ]
then
	echo >&2 "Error: failed to annotate input"
	exit 1
fi

cat annotated.pa | awk '{print (NR-1) " " $0}' | grep -v "$FOCUS_MODE" | awk '{print "system.setParticleMass(" $1 ", 0.0)"}' > freezing.py

{
cat << 'EOF'
from simtk.openmm.app import *
from simtk.openmm import *
from simtk.unit import *

pdb = PDBFile('prepared_with_simtk.pdb')
forcefield = ForceField('amber99sb.xml', 'amber99_obc.xml')
system = forcefield.createSystem(pdb.topology)
EOF

cat freezing.py

cat << 'EOF'
integrator = VerletIntegrator(0.001*picoseconds)
simulation = Simulation(pdb.topology, system, integrator)
simulation.context.setPositions(pdb.positions)
simulation.minimizeEnergy(maxIterations=MAX_ITERATIONS)
positions = simulation.context.getState(getPositions=True).getPositions()
PDBFile.writeFile(simulation.topology, positions, open('relaxed.pdb', 'w'), keepIds=True)
EOF
} \
| sed "s|MAX_ITERATIONS|${MAX_ITERATIONS}|" \
> relax.py

echo >&2 "Relaxing with OpenMM"
time -p python relax.py

if [ ! -s "relaxed.pdb" ]
then
	echo >&2 "Error: failed to relax with OpenMM"
	exit 1
fi

ls input.pdb relaxed.pdb | voronota-js-fast-iface-voromqa -i _list | column -t

cd - &> /dev/null

if [ "$OUTFILE" != "/dev/null" ]
then
	mkdir -p "$(dirname "$OUTFILE")"
fi

cat "$TMPLDIR/relaxed.pdb" > "$OUTFILE"

exit 0

