<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Voronota-LT Web</title>
		<style>
			table
			{
				border-collapse: collapse;
			}
			
			table, td, th
			{
			  border: 1px solid black;
			  padding: 5px;
			  text-align: left;
			}

			tr:hover
			{
				background-color:#ccccff;
			}
		</style>
</head>
<body>
	<h1>Voronota-LT Web</h1>

	<div id="container-for-input">
		<label for="fileInput">Input file:</label>
		<input id="fileInput" type="file" autocomplete="off"/>
	</div>

	<div id="container-for-actions">
		<button onclick="runVoronotaLT()">Run Voronota-LT</button>
	</div>
	
	<div id="container-for-log"></div>
	
	<div id="container-for-links"></div>
	
	<script src="voronota_lt_web.js"></script>
	
	<script>
		function generateAndOpenPage(tsvContent, filename)
		{
			let htmlContent = `
				<!DOCTYPE html>
				<html lang="en">
				<head>
					<meta charset="UTF-8">
					<meta name="viewport" content="width=device-width, initial-scale=1.0">
					<title>${filename}</title>
					<style>
						table
						{
							border-collapse: collapse;
						}

						table, td, th
						{
							border: 1px solid black;
							padding: 5px;
							text-align: left;
						}
					</style>
				</head>
				<body>
					<h1>Viewing: ${filename}</h1>
					<table>
			`;

			const rows = tsvContent.split('\n').map(row => row.split('\t'));
			rows.forEach((row, index) => {
				if(row[0])
				{
					htmlContent += '<tr>';
					row.forEach(cell => {
						htmlContent += (index === 0 ? `<th>${cell}</th>` : `<td>${cell}</td>`);
					});
					htmlContent += '</tr>\n';
				}
			});

			const finalHtmlContent = htmlContent + `
					</table>
				</body>
				</html>
			`;

			const newWindow = window.open('', '_blank');
			newWindow.document.write(finalHtmlContent);
			newWindow.document.close();
		}
	</script>
	
	<script>
		let Module;
		(async () => { Module = await createVoronotaLTWebModule(); })();

		async function runVoronotaLT()
		{
			const container_for_log = document.getElementById("container-for-log");
			container_for_log.innerHTML = "";

			const container_for_links = document.getElementById("container-for-links");
			container_for_links.innerHTML = "";

			const fileInput = document.getElementById("fileInput");

			if(fileInput.files.length === 0)
			{
				alert("Please provide an input file.");
				return;
			}

			container_for_log.innerHTML = "Running ...";

			const file = fileInput.files[0];
			const reader = new FileReader();

			setTimeout(async () => {

			reader.onload = async () => {

				const input_content = reader.result;

				const vector = Module.generate_results(input_content);
				const strings = [];
				for(let i=0;i<vector.size();i++)
				{
					strings.push(vector.get(i));
				}
				vector.delete();

				container_for_log.innerHTML = "";

				const table = document.createElement("table");

				const thead = document.createElement("thead");

				{
					const trow = document.createElement("tr");

					{
						const cell = document.createElement("th");
						cell.textContent="Output files";
						trow.appendChild(cell);
					}

					{
						const cell = document.createElement("th");
						cell.textContent="";
						trow.appendChild(cell);
					}

					{
						const cell = document.createElement("th");
						cell.textContent="";
						trow.appendChild(cell);
					}

					{
						const cell = document.createElement("th");
						cell.textContent="";
						trow.appendChild(cell);
					}

					thead.appendChild(trow);
				}

				const tbody = document.createElement("tbody");

				let error_status=0;

				for(let index=0;index<strings.length && error_status==0;index+=2)
				{
					const i1=index;
					const i2=index+1;

					if(i2>=strings.length)
					{
						container_for_log.innerHTML = "Failed to produce valid output.";
						error_status=1;
					}
					else
					{
						if(strings[i1]=="error")
						{
							container_for_log.innerHTML = strings[i2];
							error_status=2;
						}
						else if(strings[i1]=="log")
						{
							const sep = document.createElement("hr");
							container_for_log.appendChild(sep);

							const logfield = document.createElement("pre");
							logfield.textContent = strings[i2];
							container_for_log.appendChild(logfield);
						}
						else if(strings[i2])
						{
							const trow = document.createElement("tr");

							const filename=(strings[i1]+".tsv");
							const blob = new Blob([strings[i2]], { type: "text/plain" });
							const kilobytes=(blob.size/1024);
							const megabytes=(kilobytes/1024);


							{
								const cell = document.createElement("td");
								cell.textContent=filename;
								trow.appendChild(cell);
							}

							{
								const cell = document.createElement("td");
								if(megabytes<5)
								{
									const link = document.createElement("a");
									link.href = "#";
									link.textContent = "view";
									link.style.display = "block";
									link.onclick = (event) => {
										event.preventDefault();
										generateAndOpenPage(strings[i2], filename);
									};
									cell.appendChild(link);
								}
								else
								{
									cell.textContent="";
								}
								trow.appendChild(cell);
							}

							{
								const url = URL.createObjectURL(blob);
								const link = document.createElement("a");
								link.href = url;
								link.download = filename;
								link.textContent = "download";
								link.style.display = "block";
								link.onclick = () => setTimeout(() => URL.revokeObjectURL(url), 100);
								const cell = document.createElement("td");
								cell.appendChild(link);
								trow.appendChild(cell);
							}

							{
								const cell = document.createElement("td");
								if(megabytes<1)
								{
									cell.textContent=""+kilobytes.toFixed(2)+" KB";
								}
								else
								{
									cell.textContent=""+megabytes.toFixed(2)+" MB";
								}
								trow.appendChild(cell);
							}

							tbody.appendChild(trow);
						}
					}

					if(error_status==0)
					{
						table.appendChild(thead);
						table.appendChild(tbody);
						container_for_links.appendChild(table);
					}
				}
			};

			}, 0);

			reader.readAsText(file);
		}
	</script>
</body>
</html>

