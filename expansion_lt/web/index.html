<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Voronota-LT Web</title>
			<style>
			
			table {
			  border-collapse: collapse;
			}
			
			table, td, th {
			  border: 1px solid black;
			  padding: 5px;
			  text-align: left;
			}
			
			tr:hover {background-color:#ccccff;}
			
			</style>
</head>
<body>
	<h1>Voronota-LT Web</h1>
	
	<label for="fileInput">Input file:</label>
	<input id="fileInput" type="file" autocomplete="off"/>
	<br>
	<button onclick="runVoronotaLT()">Run Voronota-LT</button>
	
	<div id="container-for-log"></div>
	
	<div id="container-for-links"></div>
	
	<script src="voronota_lt_web.js"></script>
	
	<script>
function generateAndOpenPage(tsvContent, filename)
{
	let htmlContent = `
		<!DOCTYPE html>
		<html lang="en">
		<head>
			<meta charset="UTF-8">
			<meta name="viewport" content="width=device-width, initial-scale=1.0">
			<title>${filename}</title>
			
			<style>
			
			table {
			  border-collapse: collapse;
			}
			
			table, td, th {
			  border: 1px solid black;
			  padding: 5px;
			  text-align: left;
			}
			
			tr:hover {background-color:#ccccff;}
			
			</style>

		</head>
		<body>
			<h1>Viewing: ${filename}</h1>
			<table>
	`;

	const rows = tsvContent.split('\n').map(row => row.split('\t'));
	rows.forEach((row, index) => {
		if(row[0])
		{
			htmlContent += '<tr>';
			row.forEach(cell => {
				htmlContent += index === 0 
					? `<th>${cell}</th>` 
					: `<td>${cell}</td>`;
			});
			htmlContent += '</tr>\n';
		}
	});

	// Close the HTML
	const finalHtmlContent = htmlContent + `
			</table>
		</body>
		</html>
	`;

	// Open a new window and write the HTML content
	const newWindow = window.open('', '_blank');
	newWindow.document.write(finalHtmlContent);
	newWindow.document.close();
}
	</script>
	
	<script>
		let Module;
		(async () => { Module = await createVoronotaLTWebModule(); })();

	async function runVoronotaLT()
	{
		const fileInput = document.getElementById("fileInput");
	
		if(fileInput.files.length === 0)
		{
			alert("Please provide an input file.");
			return;
		}
	
		const file = fileInput.files[0];
		const reader = new FileReader();
		
		reader.onload = async () => {
			const container_for_log = document.getElementById("container-for-log");
			container_for_log.innerHTML = "";
			
			const container_for_links = document.getElementById("container-for-links");
			container_for_links.innerHTML = "";
			
			const input_content = reader.result;
	
			const vector = Module.generate_results(input_content);
			const strings = [];
			for(let i=0;i<vector.size();i++)
			{
				strings.push(vector.get(i));
			}
			vector.delete();
			
			const table = document.createElement("table");
			
			const thead = document.createElement("thead");
			
			{
            	const trow = document.createElement("tr");
            	
            	{
					const cell = document.createElement("td");
					cell.textContent="Table file name";
					trow.appendChild(cell);
				}
				
            	{
					const cell = document.createElement("td");
					cell.textContent="";
					trow.appendChild(cell);
				}
				
				{
					const cell = document.createElement("td");
					cell.textContent="";
					trow.appendChild(cell);
				}
				
				{
					const cell = document.createElement("td");
					cell.textContent="";
					trow.appendChild(cell);
				}
				
				thead.appendChild(trow);
            }
            
			const tbody = document.createElement("tbody");
			
			for(let index=0;index<strings.length;index+=2)
			{
				const i1=index;
				const i2=index+1;
				
				if(i2>=strings.length)
				{
					alert("Failed to produce valid output.");
				}
				else
				{
					if(strings[i1]=="error")
					{
						alert(strings[i2]);
					}
					else if(strings[i1]=="log")
					{
						const sep = document.createElement("hr");
						container_for_log.appendChild(sep);
						
						const logfield = document.createElement("pre");
						logfield.textContent = strings[i2];
						container_for_log.appendChild(logfield);
					}
					else if(strings[i2])
					{
						const trow = document.createElement("tr");
						
						const filename=(strings[i1]+".tsv");
						const blob = new Blob([strings[i2]], { type: "text/plain" });
						
						
						{
							const cell = document.createElement("td");
							cell.textContent=filename;
							trow.appendChild(cell);
						}
						
						{
							const cell = document.createElement("td");
							const megabytes=(blob.size/1024/1024);
							if(megabytes<5)
							{
								const link = document.createElement("a");
								link.href = "#";
								link.textContent = "view";
								link.style.display = "block";
								link.onclick = (event) => {
									event.preventDefault();
									generateAndOpenPage(strings[i2], filename);
								};
								cell.appendChild(link);
							}
							else
							{
								cell.textContent="";
							}
							trow.appendChild(cell);
						}
						
						{
							const url = URL.createObjectURL(blob);
							const link = document.createElement("a");
							link.href = url;
							link.download = filename;
							link.textContent = "download";
							link.style.display = "block";
							link.onclick = () => setTimeout(() => URL.revokeObjectURL(url), 100);
							const cell = document.createElement("td");
							cell.appendChild(link);
							trow.appendChild(cell);
						}
						
						{
							const cell = document.createElement("td");
							const kilobytes=(blob.size/1024);
							const megabytes=(kilobytes/1024);
							if(megabytes<1)
							{
								cell.textContent=""+kilobytes.toFixed(2)+" KB";
							}
							else
							{
								cell.textContent=""+megabytes.toFixed(2)+" MB";
							}
							trow.appendChild(cell);
						}
						
						tbody.appendChild(trow);
					}
				}
				
				table.appendChild(thead);
				table.appendChild(tbody);
				container_for_links.appendChild(table);
			}
		};
	
		reader.readAsText(file);
	}
	</script>
</body>
</html>

