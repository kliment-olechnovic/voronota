function print_help_and_exit
{
cat >&2 << 'EOF'

'v-save-image' is a script that can be called from the 'voronota-scripting-env'
environment to save 'voronota-viewer' screenshot image

Options:
    --output | -o     string   *  output image file, alternatively can be provided as an unnamed argument
    --help | -h                   flag to display help message and exit

EOF
exit 1
}

v-test-env || { echo >&2 "Error: 'voronota-scripting-env' environment not valid"; exit 1; }

if [ "$V_GUI" != "true" ]
then
	echo >&2 "Error: Voronota not running in GUI mode"
	exit 1
fi

OUTPUT_FILE=""
HELP_MODE=false

while [[ $# > 0 ]]
do
	OPTION="$1"
	OPTARG="$2"
	shift
	case $OPTION in
	-o|--outfile)
		OUTPUT_FILE="$OPTARG"
		shift
		;;
	-h|--help)
		HELP_MODE=true
		;;
	*)
		[ -z "$OUTPUT_FILE" ] || { echo >&2 "Error: invalid command line option '$OPTION'"; exit 1; }
		OUTPUT_FILE="$OPTION"
		;;
	esac
done

if $HELP_MODE
then
	print_help_and_exit
fi

if [ -z "$OUTPUT_FILE" ]
then
	echo >&2 "Error: missing output file path"
	exit 1
fi

command -v convert &> /dev/null || { echo >&2 "Error: 'convert' executable not in binaries path"; exit 1; }

readonly TMPLDIR=$(mktemp -d)

function on_exit_final
{
	rm -r $TMPLDIR
}

trap on_exit_final EXIT

v-do-silent "screenshot '$TMPLDIR/image.ppm'"

if [ ! -s "$TMPLDIR/image.ppm" ]
then
	echo >&2 "Error: failed to capture screenshot"
	exit 1
fi

convert "$TMPLDIR/image.ppm" "$OUTPUT_FILE"

