function print_help_and_exit
{
cat >&2 << 'EOF'

'v-tmalign-all' is a script that can be called from the 'voronota-scripting-env'
environment to use TMalign to superpose all protein objects on a single target

Options:
    --target | -t          string      target name, first object is chosen if no name provided
    --target-sel | -ts     string      target atoms selection expression
    --model-sel | -ms      string      model atoms selection expression
    --help | -h                        flag to display help message and exit

EOF
exit 1
}

v-test-env || { echo >&2 "Error: 'voronota-scripting-env' environment not valid"; exit 1; }

command -v TMalign &> /dev/null || { echo >&2 "Error: 'TMalign' executable not in binaries path"; exit 1; }

TARGET_NAME=""
TARGET_SEL="[]"
MODEL_SEL="[]"
HELP_MODE=false

while [[ $# > 0 ]]
do
	OPTION="$1"
	OPTARG="$2"
	shift
	case $OPTION in
	-t|--target)
		TARGET_NAME="$OPTARG"
		shift
		;;
	-ts|--target-sel)
		TARGET_SEL="$OPTARG"
		shift
		;;
	-ms|--model-sel)
		MODEL_SEL="$OPTARG"
		shift
		;;
	-h|--help)
		HELP_MODE=true
		;;
	*)
		echo >&2 "Error: invalid command line option '$OPTION'"
		exit 1
		;;
	esac
done

if $HELP_MODE
then
	print_help_and_exit
fi

if [ -z "$TARGET_NAME" ]
then
	TARGET_NAME="$(v-do "list-objects" | jq -r '.commands[0].output.objects[].name' 2> /dev/null | head -1)"
fi

if [ -z "$TARGET_NAME" ]
then
	echo >&2 "Error: missing target name"
	exit 1
fi

v-do-silent  "list-objects '$TARGET_NAME'"

if [ "$V_TAIL_SUCCESS" != "true" ]
then
	echo >&2 "Error: no target object '$TARGET_NAME'"
	exit 1
fi

v-do "list-objects" \
| jq -r '.commands[0].output.objects[].name' \
| while read MODEL_NAME
do
	if [ "$MODEL_NAME" != "$TARGET_NAME" ]
	then
		v-tmalign -t "$TARGET_NAME" -m "$MODEL_NAME" -ts "$TARGET_SEL" -ms "$MODEL_SEL"
	fi
done

